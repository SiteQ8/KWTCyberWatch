#!/usr/bin/env python3

import certstream
import re

# List of keywords to search in domain names
keywords = ['kuwait', 'kw', 'kwt', 'kwi', 'q8']

# Function to check if the domain contains any of the specified keywords
def domain_contains_keywords(domain, keywords):
    return any(keyword.lower() in domain.lower() for keyword in keywords)

# Function to handle incoming certstream data
def handle_message(message, context):
    if message['message_type'] == 'certificate_update':
        try:
            # Extract the domain (CN) from the certificate
            cert_domains = message['data']['leaf_cert']['all_domains']
            for domain in cert_domains:
                if domain_contains_keywords(domain, keywords):
                    with open('filtered_domains.txt', 'a') as file:
                        file.write(domain + '\n')
                    print(f"Found domain: {domain}")
        except KeyError:
            pass

# Connect to CertStream and start streaming
def start_certstream():
    certstream.listen_for_events(handle_message, url='wss://certstream.calidog.io/')
    print("Listening for CertStream updates...")

if __name__ == '__main__':
    start_certstream()
